<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Transmisi√≥n en Vivo</title>
  <style>
    body {
      margin: 0;
      background-image: url('https://i.postimg.cc/Y0cNyFhG/fondo-fondo-andino.png');
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      height: 100vh;
      overflow: hidden;
    }

    iframe {
      width: 90vw;
      height: 50vw;
      max-width: 1000px;
      border: none;
      display: block;
      margin: 50px auto;
      z-index: 1;
      position: relative;
    }

    canvas#cohetesCanvas {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 999;
      pointer-events: none;
    }
  </style>
</head>
<body>

  <!-- Video de YouTube -->
  <iframe id="youtube-frame" allowfullscreen allow="autoplay"></iframe>

  <!-- Lienzo para cohetes -->
  <canvas id="cohetesCanvas"></canvas>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/fireworks-js@2.10.3/dist/fireworks.umd.js"></script>

  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      const supabase = window.supabase.createClient(
        'https://dbkixcpwirjwjvjintkr.supabase.co',
        'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRia2l4Y3B3aXJqd2p2amludGtyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDYwNjYxNDksImV4cCI6MjA2MTY0MjE0OX0.QJmWLWSe-pRYwxWeel8df7JLhNUvMKaTpL0MCDorgho'
      );

      // Cargar el video de YouTube desde Supabase
      async function cargarVideo() {
        const { data, error } = await supabase
          .from('configuracion')
          .select('valore')
          .eq('clave', 'youtube_live')
          .single();

        if (error || !data) {
          console.error("Error al obtener el video", error);
          return;
        }

        const url = data.valore;
        const id = url.includes("youtu.be")
          ? url.split("/").pop()
          : new URL(url).searchParams.get("v");

        document.getElementById("youtube-frame").src = `https://www.youtube.com/embed/${id}?autoplay=1`;
      }

      cargarVideo();

      // Configurar cohetes
      const canvas = document.getElementById('cohetesCanvas');
      const fireworks = new Fireworks(canvas, {
        hue: { min: 0, max: 360 },
        delay: { min: 15, max: 30 },
        rocketsPoint: 50,
        speed: 2,
        acceleration: 1.05,
        friction: 0.97,
        gravity: 1.5,
        particles: 50,
        trace: 3,
        explosion: 5
      });

      // Escuchar cambios en la clave "cohetes_activados"
      supabase
        .channel('cohetes')
        .on('postgres_changes', {
          event: 'UPDATE',
          schema: 'public',
          table: 'configuracion',
          filter: 'clave=eq.cohetes_activados'
        }, (payload) => {
          if (payload.new.valore === true || payload.new.valore === "true") {
            fireworks.start();
            setTimeout(() => {
              fireworks.stop();
              supabase.from('configuracion')
                .update({ valore: false })
                .eq('clave', 'cohetes_activados');
            }, 8000);
          }
        })
        .subscribe();
    });
  </script>
</body>
</html>
